# JavaScript для Price/index.php

Этот документ описывает встроенный JavaScript в файле `index.php` и рекомендуемое разбиение кода на отдельные модули. Разделение позволит подключать сценарии по мере необходимости и упростит поддержку.

## Основные функции скрипта

1. **loadData** – загружает данные товаров через `fetch` и инициализирует таблицу.
2. **filterByUserFolders** – ограничивает набор товаров в соответствии с папками пользователя.
3. **groupProductsByCategory / createTabs / showTab** – группировка товаров и создание вкладок.
4. **fillTable** – постраничное заполнение таблицы товаров. Группирует записи по странам и, если внутри страны встречаются разные типы чая из колонки «Тип», добавляет строку-заголовок с названием типа.
5. **fillFilters** – формирование списков фильтров по типу и поставщику.
6. **applyFilters** – применение выбранных фильтров к текущему набору данных.
7. **openModal / closeModal** – показ увеличенного фото товара.
8. **formatStock / openProductModal / closeProductModal** – правая панель с подробностями о товаре.
9. **loadImageAsBase64** – вспомогательная функция для экспорта в Excel.
10. **DOMContentLoaded** – точка входа: старт загрузки данных и привязка обработчиков.
11. **__groupedData / __currentGroup** – глобальные переменные с разбитыми по вкладкам данными и именем активной группы.

## Предлагаемая структура файлов

Для упорядочивания кода рекомендуется вынести каждую логическую группу в отдельный файл. Ниже приведён пример возможного разбиения. Имена файлов можно корректировать по вкусу, но содержание следует документировать с помощью JSDoc.

| Файл | Содержимое |
|------|------------|
|`data-loader.js`|Функции `loadData`, `filterByUserFolders` и `loadImageAsBase64`. Отвечает за получение данных и вспомогательные утилиты.|
|`tabs.js`|`groupProductsByCategory`, `createTabs` и `showTab`. Управление вкладками и группировкой товаров.|
|`table.js`|`fillTable` и `fillFilters`. Заполнение таблицы и подготовка выпадающих списков.|
|`filters.js`|`applyFilters` и инициализация полей фильтрации.|
|`modals.js`|`openModal`, `closeModal`, `openProductModal`, `closeProductModal`, а также `formatStock`. Работа с модальными окнами и панелью товара.|
|`export-excel.js`|Собирает `window.__productsData` и отправляет его POST-запросом на `export.php`.|
|`main.js`|Событие `DOMContentLoaded`: загрузка данных, привязка кликов к кнопкам и элементам интерфейса. Подключает остальные модули.|

Каждый файл должен подключаться в `index.php` через отдельный тег `<script>` либо собираться в единый бандл. Внутри файлов используйте комментарии в формате JSDoc, чтобы описать назначение функций, параметры и возвращаемые значения.

При дальнейшем рефакторинге код можно перевести на ES6‑модули, импортируя нужные функции в `main.js`. Важно сохранить существующие id и классы элементов, чтобы разметка и стили продолжили работать без изменений.

## История изменений

- 2025-05-22 16:29 – создан документ `js_index.md` с описанием функций и структуры модулей.
- 2025-05-22 16:35 – JavaScript вынесен из `index.php` в отдельные файлы.

- 2025-05-22 17:10 Price/js/table.js – добавлена сортировка по странам и пример функции настройки порядка стран.
- 2025-05-26 12:20 docs/js_index.md – добавлено описание группировки типов чая внутри страны.

- 2025-05-22 17:20 Price/js/table.js – задан порядок стран и реализована алфавитная сортировка типов.
- 2025-05-22 17:28 Price/js/table.js – реализовано разделение товаров по типам внутри страны.

- 2025-05-22 18:22 docs/export_excel.md – добавлено описание механизма экспорта.
- 2025-05-23 08:42 Price/index.php, Price/js/cart.js – реализована клиентская корзина.
- 2025-05-23 09:30 Price/js/cart.js, Price/js/modals.js – ограничение количества запасом и ввод числа без спиннеров.
- 2025-05-30 13:10 Price/index.php, Price/js/cart.js – добавлена кнопка удаления позиции и убран крестик закрытия корзины.
- 2025-06-01 10:30 Price/js/cart.js – кнопка удаления теперь отображает значок корзины.
- 2025-05-23 12:45 Price/js/cart.js, Price/js/modals.js – добавлен выбор склада при добавлении в корзину.
- 2025-06-10 11:00 Price/js/cart.js – добавлена панель `cart-footer` с подсчётом суммы
  и кнопкой подтверждения заказа.

- 2025-06-20 09:30 Price/js/table.js, Price/data.php – колонка "Наличие в кг" теперь
  отображает только целые числа. Позиции с нулевым остатком скрываются,
  за исключением вкладок «Ароматизированный чай» и «Приправы».

- 2025-06-02 13:35 Price/js/table.js, Price/export.php – окончательная сортировка
  внутри типа выполняется по названию товара.
- 2025-06-23 Price/js/rules-loader.js, Price/js/table.js, Price/js/main.js – правила сортировки и столбцов загружаются из JSON.
- 2025-06-25 Price/js/rules-loader.js, Price/js/table.js – поддержка `enabled` и `typeSort` в правилах.
- 2025-06-26 Price/admin.php – скрипт для добавления полей стран в разделе правил.
- 2025-06-30 Price/admin.php – поля стран переведены на select2, список стран подгружается из «МойСклад».




- 2025-07-15 Price/admin.php – инициализация select2 для всех select.
- 2025-07-20 Price/admin.php – список стран стал перетаскиваемым через jQuery UI.
- 2025-07-25 Price/admin.php – добавлено редактирование порядка типов чая.
- 2025-08-02 Price/admin.php – управление списком `column_rules.json` (переименование и выключение столбцов).
- 2025-08-26 Price/data.php, Price/js/table.js – отображение товаров без остатка для групп «Ароматизированный чай», «Травы и добавки» и «Приправы».

- 2025-08-26 Price/js/filters.js – фильтр по складу оставляет товары из групп «Ароматизированный чай», «Травы и добавки» и «Приправы» даже при нулевом остатке.
- 2025-08-27 Price/js/data-loader.js, Price/js/table.js – исправлен путь к data.php и добавлена группа «Травы и добавки» в список ALWAYS_SHOW_GROUPS.

- 2025-06-27 16:17 Price/index.php, Price/js/modals.js – снова активирована клиентская корзина.
- 2025-06-27 13:29 Price/index.php, Price/js/cart.js – удалена клиентская корзина.
- 2025-06-27 14:23 Price/js/main.js – удалён вызов `setupCart`, мешавший работе скриптов.
- 2025-11-05 Price/js/table.js – клики по строкам обрабатываются через делегирование события, исправлено открытие панели товара.

- 2025-11-06 Price/js/table.js – обработчик клика подключается через `addEventListener` с удалением старого слушателя.

