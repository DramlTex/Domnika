# DOCUMENTATION

## Краткое введение

Проект представляет собой набор PHP-скриптов для интеграции с сервисом "МойСклад" и веб-интерфейс для отображения прайс‑листа. Основная логика расположена в каталоге `Price`, также присутствуют вспомогательные скрипты в корне репозитория. Расширенная документация по коду хранится в каталоге `docs`.

## Архитектура приложения

- **`product.php`** – CLI‑скрипт для выгрузки товаров из API и сохранения отфильтрованного списка в `output/filtered_products.json`.
- **`output/update.php`** – обновляет товары в "МойСклад" добавляя недостающие упаковки.
- **Каталог `Price`** – веб‑интерфейс прайс‑листа и система авторизации.
  - `login.php`, `admin.php`, `index.php` – основные страницы.
  - `data.php` – загрузка данных из API с учётом складов.
  - `export.php` – экспорт текущего прайса в Excel с использованием `phpoffice/phpspreadsheet`.
  - `config.php` – хранит учётные данные для API.

## Структура каталога

```
/Price          – веб‑интерфейс и вспомогательные файлы
/output         – JSON‑файлы и скрипты обновления
scripts/        – утилиты для установки, тестирования и запуска
product.php     – утилита загрузки товаров
composer.json   – зависимости проекта
docs/           – дополнительная документация (PHP, JS, HTML, CSS)
```

## Установка

Требуется PHP 8 и Composer. Запустите скрипт:

```bash
scripts/install.sh
```

Он установит PHP‑зависимости, определённые в `composer.json`.

## Настройка окружения

1. Укажите логин и пароль для "МойСклад" в файле `Price/config.php`.
2. При необходимости скорректируйте пути в `product.php` и `output/update.php`.

## Запуск приложения

Локальный веб‑сервер можно запустить командой:

```bash
scripts/start.sh
```

После запуска интерфейс будет доступен на `http://localhost:8000/`.

## Запуск и тестирование

Для запуска тестов (если они появятся) используйте:

```bash
scripts/test.sh
```

По умолчанию скрипт выводит сообщение о том, что тесты не настроены.

## Правила фиксации изменений

- Перед коммитом проверяйте изменённые PHP‑файлы командой `php -l <file>`.
- Описывайте в сообщениях коммитов найденные и исправленные ошибки.

## История изменений
- 2025-05-22 16:35 Price/index.php – вынесен JavaScript в отдельные файлы

- Изначальная версия документа.
- 2025-05-22 15:51 Price/index.php, docs/css_index.md – добавлена документация по CSS.
- 2025-05-22 16:29 Price/index.php, docs/js_index.md – добавлена документация по JavaScript.
- 2025-05-22 16:50 agents.md, docs/css_index.md, docs/js_index.md – добавлены журналы изменений для CSS и JS.
- 2025-05-26 12:00 docs/css_index.md – добавлено описание разбиения стилей на файлы.
- 2025-05-22 16:58 Price/index.php, Price/js/table.js – стили вынесены в каталог `css`.
- 2025-05-22 17:10 Price/js/table.js, Price/css/table.css – добавлена сортировка по странам и стиль заголовков; создан файл docs/table.md.
- 2025-05-22 17:28 Price/js/table.js, Price/css/table.css – добавлено разделение по типам с классом `.type-row`.
- 2025-05-27 10:00 Price/index.php, Price/js/table.js, Price/css/table.css – ячейки колонок "Тип" и "Страна" получили классы `.type-cell` и `.country-cell`.
- 2025-05-22 18:22 docs/export_excel.md – описан процесс экспорта прайса в Excel.
- 2025-05-27 12:40 Price/index.php, Price/css/table.css – расширена колонка названия, добавлены классы `.name-cell` и `.num-cell`.
- 2025-05-22 21:40 Price/index.php, Price/css/table.css – добавлен контейнер `.table-scroll` и возвращено фиксирование шапки.
- 2025-05-23 06:45 Price/css/table.css – закреплена шапка таблицы через `position: sticky`.
- 2025-05-23 06:50 docs/php/overview.md – добавлено описание PHP-скриптов.
- 2025-05-23 07:05 docs/php/data.md – подробная документация по Price/data.php.
- 2025-05-30 09:30 docs/php/data.md – расширено описание функций получения товаров.
- 2025-05-23 07:08 docs/php/data.md – добавлено руководство по патчу для модификаций без родителя.
- 2025-05-23 07:45 docs/admin/php.md – создана документация по admin.php
- 2025-05-30 11:10 Price/evt/data.php – добавлен дозагрузчик родительского товара для модификаций
- 2025-05-23 08:42 Price/index.php, Price/js/cart.js – добавлена клиентская корзина
- 2025-05-23 09:30 Price/js/cart.js, Price/js/modals.js – поле количества без спиннеров и ограничено остатком
- 2025-05-30 12:30 docs/cart.md – создан файл документации по клиентской корзине
- 2025-05-30 13:10 Price/index.php, Price/js/cart.js, Price/css/cart.css – добавлена кнопка удаления из корзины и убран крестик закрытия.
- 2025-06-01 10:30 Price/index.php, Price/js/cart.js, Price/css/cart.css – кнопка удаления с иконкой корзины и фиксированный размер кнопки "Корзина".
- 2025-06-01 12:00 Price/css/cart.css – исправлено отображение счётчика корзины, перенесено количество на отдельную строку.
- 2025-05-23 12:45 Price/index.php, Price/js/cart.js, Price/js/modals.js – выбор склада при добавлении в корзину.

- 2025-05-23 16:01 docs/cart.md – обновлены рекомендации по дальнейшему развитию корзины.
- 2025-06-10 09:00 docs/cart.md – переработаны планы развития корзины.
- 2025-06-10 11:00 Price/index.php, Price/js/cart.js, Price/css/cart.css – доба
влена панель `cart-footer` с полями оформления заказа.
- 2025-06-10 11:30 docs/cart.md – расширен пункт об адаптивной верстке корзины.
- 2025-06-10 12:00 Price/init.php, docs/php/overview.md – обновлено описание инициализации администратора.

- 2025-06-20 09:30 Price/data.php, Price/js/table.js – удалены дроби в колонке
  "Наличие в кг" и скрыты товары с нулевым остатком.

- 2025-06-20 12:00 Price/export.php, docs/export_excel.md – добавлено форматирование целых чисел и опциональная колонка "Мин. заказ".

- 2025-06-21 10:30 Price/export.php – ширина столбца "Тип" вычисляется по самому длинному слову.
- 2025-06-21 11:00 Price/js/filters.js, Price/js/tabs.js, Price/js/data-loader.js, docs/js_index.md – правка фильтрации по вкладкам.
- 2025-06-22 docs/columns/README.md – добавлено описание процесса вывода столбцов.
- 2025-06-23 Price/js/rules-loader.js, docs/columns/README.md – правила сортировки вынесены в JSON.
- 2025-06-24 Price/admin.php, Price/login.php, Price/index.php, Price/js/rules-loader.js – индивидуальный файл правил для пользователей.
- 2025-06-25 Price/column_rules.json, Price/row_sort_rules.json, Price/js/rules-loader.js, Price/js/table.js – расширены настройки правил сортировки и колонок.
- 2025-06-26 Price/admin.php, docs/columns/README.md – редактирование порядка стран перенесено в admin.php.
- 2025-06-30 Price/admin.php – форма порядка стран использует select2 и загружает список стран из «МойСклад».
- 2025-07-20 Price/admin.php – страны можно сортировать перетаскиванием через jQuery UI.
- 2025-07-25 Price/admin.php – добавлено управление порядком типов чая.
- 2025-06-02 Price/admin.php – добавлены классы `.btn-msk` и `.ms-form-control`.
- 2025-07-30 Price/admin.php – удалены кнопки "Добавить" и "Удалить" в форме columnForm.
- 2025-06-02 19:15 Price/admin.php, docs/admin/php.md – контрагенты и группы товаров загружаются при загрузке страницы, кнопки обновления удалены.
- 2025-06-03 07:09 Price/admin.php, Price/styles.css, docs/admin/php.md, docs/admin/css.md – добавлена ссылка выхода из учётной записи.
- 2025-08-15 Price/admin.php, docs/admin/php.md – объединены формы правил и единая кнопка сохранения.


- 2025-08-20 Price/admin.php, Price/css/admin.css, docs/admin/css.md – стили вынесены из файла и панель получила заголовки.
- 2025-08-26 10:00 Price/data.php, Price/js/table.js – товары из вкладок «Ароматизированный чай» и «Приправы» отображаются без остатка.
- 2025-08-26 10:20 Price/js/filters.js – фильтр по складу не скрывает такие товары.

- 2025-06-09 Price/admin.php, docs/admin/php.md – данные "МойСклад" кешируются в сессии и не загружаются при сохранении.
- 2025-06-26 Price/data.php – расширено логирование запросов к «МойСклад».
- 2025-06-26 11:27 Price/data.php, docs/php/data.md – кеширование неподходящих родителей, чтобы не повторять запросы.
- 2025-06-26 15:00 Price/data.php, docs/php/data.md – повторные обращения к одному URL теперь возвращаются из кеша.
- 2025-09-05 12:00 webhook.php, Price/data.php, docs/php/webhook.md – добавлен обработчик вебхуков и использование локальной базы товаров.
- 2025-06-27 10:16 webhook.php – вывод текста ответа при ошибке запросов к «МойСклад».

- 2025-06-27 10:20 webhook.php – исправлен заголовок Accept в запросах.
- 2025-11-01 output/init_db.php, docs/php/init_db.md – скрипт начальной загрузки базы товаров и модификаций.
- 2025-11-02 Price/data.php, docs/php/data.md – расширено логирование работы скрипта.


## Рекомендации по улучшению

- Добавить автоматические тесты и линтеры.
- Настроить CI для проверки и деплоя.

