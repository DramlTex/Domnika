# Экспорт данных в Excel

Этот документ описывает файлы и процессы, связанные с функцией выгрузки прайс‑листа в формат Excel.

## Общая схема
1. На странице `Price/index.php` присутствует кнопка `<button class="btn" id="export-button">Экспорт в Excel</button>`.
2. В файле `Price/js/main.js` при загрузке страницы к этой кнопке привязывается обработчик `exportToExcel`.
3. Функция `exportToExcel` определена в `Price/js/export-excel.js`. Она берет данные из `window.__productsData`, формирует скрытую форму и отправляет её методом POST на `export.php`.
4. Скрипт `Price/export.php` получает JSON‑данные и с помощью библиотеки `phpoffice/phpspreadsheet` формирует Excel‑файл, который сразу отдается пользователю для скачивания.

## Связанные файлы
- **`Price/js/export-excel.js`** – формирует JSON и отправляет его на сервер.
- **`Price/js/main.js`** – добавляет обработчик клика на кнопку экспорта.
- **`Price/js/data-loader.js`** – загружает товары и сохраняет их в `window.__productsData`.
- **`Price/index.php`** – содержит HTML‑кнопку экспорта и подключает все скрипты.
- **`Price/export.php`** – серверная часть, создающая и отправляющая `.xlsx` файл. В каталоге также есть `export1.php` – предыдущая версия скрипта.

## Стили и оформление Excel
Все операции по оформлению создаваемого Excel‑файла выполняются в `Price/export.php` с использованием библиотеки **PhpSpreadsheet**. Скрипт задаёт ширину столбцов и высоту строк, вставляет логотип из файла `logo_big.png`, форматирует шрифт заголовков и добавляет границы ячеек через функцию `applyBorderFill`.

Также `export.php` включает автофильтр на строку заголовков, задаёт числовые форматы для столбцов веса и цены и выравнивает данные по центру. Для колонки "Фото" скрипт формирует гиперссылку на изображение и применяет отдельный стиль `hyperlinkStyle`.

Вес, цена и остаток выводятся целыми числами без десятичных знаков. При необходимости можно включить отображение колонки "Мин. заказ" — она управляется переменной `$includeMinOrder` в `export.php`.

Начиная с версии 2025‑05‑27 экспорт повторяет логику отображения таблицы из JavaScript. Товары сортируются по странам и внутри каждой страны по типам. При смене страны или типа добавляется строка‑заголовок, оформленная так же, как классы `.country-row` и `.type-row` в `table.css`.

## Дальнейшее развитие
При изменении структуры данных или внешнего вида Excel‑файла редактируйте `export.php`. Если требуется изменить процесс вызова, обновите `export-excel.js` и соответствующие элементы в `index.php`.

## Последующие патчи
В планах реализовать считывание CSS‑стилей таблицы и автоматическое применение их при формировании Excel. Сейчас все оформления прописаны в `export.php`, поэтому правки в `table.css` не отражаются в выгружаемом файле. Предполагается создать простой парсер CSS и на его основе задавать стили библиотеке PhpSpreadsheet. По мере появления новых изменений раздел будет дополняться.
