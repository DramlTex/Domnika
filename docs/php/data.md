# data.php

Файл `Price/data.php` обеспечивает API для веб-интерфейса прайс‑листа. Он собирает остатки товаров по нескольким складам в "МойСклад" и возвращает их в формате JSON.

## Основные шаги

1. **Логирование и настройки PHP** – включается вывод ошибок в файл `php-error.log` и фиксируется начало/конец работы скрипта.
2. **Заголовки ответа** – разрешены CORS‑запросы и установлен тип `application/json`.
3. **Авторизация** – логин и пароль берутся из `config.php`, формируется базовый URL API `https://api.moysklad.ru/api/remap/1.2/`.
4. **Функция `moysklad_request()`** – отправляет HTTP запрос к API с авторизацией, проверяет код ответа и декодирует JSON. При ошибках пишет в лог.
5. **Функция `fetchAllAssortment()`** – постранично запрашивает ассортимент, объединяя результаты в единый массив. Используется параметр `expand` для загрузки связанных сущностей (страна, картинки, родительский товар).
6. **Массив `$storeIds`** – список идентификаторов складов. По каждому складу скрипт выполняет отдельный запрос, чтобы получить остатки.
7. **Функция `checkProductAttributes()`** – из атрибутов товара вытягивает «Группу для счетов», «Группу», минимальное количество, ссылку на фото и «Стандарт». Товар включается в результат только если «Группа для счетов» равна «Прайс».
8. **Функция `createCombinedEntry()`** – формирует единую запись товара: название, артикул, единицу измерения, страну, тип, вес, фото, цену, ссылки и т.п. Для модификаций используются данные родителя.
9. **Функция `processItemsFromStore()`** – проходит по всем позициям со склада. Для модификации при необходимости загружает родительский товар, затем суммирует остаток по складам. Для обычного товара сразу создаёт либо обновляет запись в массиве `$combined`.
10. **Основной цикл** – обходит все склады из `$storeIds`, вызывает `fetchAllAssortment()` и `processItemsFromStore()`.
11. **Формирование итогового массива `$rows`** – для каждого уникального товара подсчитывается общий остаток и выбираются нужные поля.
12. **Ответ JSON** – в конце скрипт выводит массив `rows` с детальной информацией о каждом товаре и завершает логирование.

Скрипт используется фронтендом прайс‑листа для загрузки актуальных данных по всем складам. Аналогичная, но упрощённая версия расположена в папке `Price/evt`.
